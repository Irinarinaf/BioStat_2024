---
title: "Классические_статистические_тесты ДЗ Гаранина"
author: "Irina Garanina"
date: "2024-11-17"
output: html_document
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(exact2x2)
library(ggplot2)
library(stats)
```

# Инструкции

Ниже приведены семь клинических (исследовательских) гипотез.
В качестве задания протестируйте их, используя соответствующие статистические критерии.
Решение должно содержать все элементы алгоритма проверки статистических гипотез:

• Сформулируете нулевую и альтернативную гипотезы.
• Укажите уровень значимости α.
• Определите статистический тест (критерий) для проверки гипотезы.
При необходимости аргументируйте выбор одностороннего теста.
• Укажите критическое значение статистики (используйте распределения из материалов лекции).
• Определите наблюдаемое значение статистики.
• Оцените статистическую значимость (p-value и/или доверительный интервал).
• Оцените практическую значимость.

-   Решение необходимо загружать в формате Rmd (воспроизводимый код). \*\* Данные для анализа необходимо генерировать самостоятельно в соответствии с каждой представленной гипотезой. По возможности используйте пакет dplyr \*\*\* Предусмотрен мягкий дедлайн (17 ноября). В этом случае вы получите комментарии с возможностью повысить оценку. Сдача работы после жёсткого дедлайна (24 ноября) предусматривает снижение оценки (10 баллов).

# Гипотеза 1. Существует ассоциация между уровнем физической активности (бинарная переменная, физическая активность может быть 'высокой' и 'низкой') и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет. Попробуйте вариант с большими выборками (sample_size \<- 100). Как изменится стратегия при малых выборках (sample_size \<- 30) ?

Нулевая гипотеза: Частота сердечно-сосудистых заболеваний не зависит от уровня физической активности, то есть не отличается у людей с высокой и низкой активностью

Альтернативная гипотеза: Частота сердечно-сосудистых заболеваний зависит от уровня физической активности, то есть она отличается у людей с высокой и низкой активностью.
Гипотеза двустороняя и не показывает в какой именно группе частота выше.

Уровень значимости: 0.05, тест по умолчанию односторонний

## Генерация данных, большая выборка

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки 
sample_size <- 100

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <-rep(c("Высокая", "Низкая"), each = sample_size/2)

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio <- ifelse(activity == "Высокая", 
                 rbinom(sample_size/2, 1, 0.5), 
                 rbinom(sample_size/2, 1, 0.6))

data_large <- data.frame(Activity = activity, Cardio = cardio)


```

## Решение, большая выборка

Хи-квадрат тест, так как он быстрее вычисляется чем тест Фишера и на больших выборках работает не хуже

```{r}

alpha = 0.05
contingency_table_large <- table(data_large$Activity, data_large$Cardio)

contingency_table_large

```

```{r}
chi2_test <- chisq.test(contingency_table_large)
chi2_test
```

Чтобы посчитать критическое значение статистики Хи-квадрат теста посчитаем 1-alpha квантиль распределения хи-квадрат с одной степенью свободы, распределение хи-квадрат всегда положительное, поэтому критическое значение считается только с одной стороны

```{r}
qchisq(1 - alpha, 1)
```

Критическое значение больше посчитанного тестом значения статистики (3.08), что не дает основания отвергнуть нулевую гипотезу

## Генерация данных, маленькая выборка

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 30

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- rep(c("Высокая", "Низкая"), each = sample_size/2)

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio <- ifelse(activity == "Высокая", 
                 rbinom(sample_size/2, 1, 0.5), 
                 rbinom(sample_size/2, 1, 0.6))

data_small <- data.frame(Activity = activity, Cardio = cardio) 
```

## Решение, маленькая выборка

На маленькой выборке тест Фишера предпочтительнее (менее 5 наблюдений на клетку таблицы), так как ассимптотические предположения хи-квадрат теста могут не выполняться.
Но так как тест Фишера является менеее мощным проведем хи-квадрат тест с симулированным p-value, который более предпочтителен для маденьких выборок.

```{r}
contingency_table_small <- table(data_small$Activity, data_small$Cardio)

contingency_table_small
```

```{r}
chi2_test_mk <- chisq.test(contingency_table_small,  simulate.p.value = TRUE, B = 10000)
chi2_test_mk
```

Результат хи-квадрат теста показал, что мы не можем отвергнуть нулевую гипотезу.
Критическое значение то же самое, что и для большей выборки 3.84, оно больше чем значение хи-квадрат статистики, полученное по выборке, значит нулевая гипотеза не отвергается.

Практическая значимость: В случае с большой выборкой статистически незначимый результат может показывать, что эффект отсутствует в данной группе пациентов, это не значит, что его нет вообще.
Например выбран неверный показатель для измерения физической активности - порог по которому определяется высокая и низкая активность.
Если у нас есть клинические основания полагать, что ассоциация есть, в этой ситуации можно попробовать измерять физическую активность количественно или попровать разные пороги для определения высокой и низкой активности, но во втором случае нужно это делать осторожно, что бы это не было подгонкой под гипотезу и использовать поправки на множественное тестирвоание.

Незначимый результат для маленькой выборки интепретировать сложнее, так как в первую очередь на мощность теста влияет именно размер выборки, поэтому неясно либо надо еще людей набрать, либо связи действительно нет как в случае с большой выборкой.

> ### Коммент Гипотеза 1. Cгенерированные данные не соответствуют условию (отношение групп 1:1 и соотношение случаев внутри). Что касается выбора теста, на лекции была рекомендация избегать использование теста Фишера (активация некой опции chi squared). Нет пункта с оценкой практической значимости.
>
> Ответ: поправила метод генерации и заменила тест Фишера на хи-квадрат тест с симулированным p-value, и добавила практическую значимость.

# Гипотеза 2. Применение нового метода лечения для пациентов с артериальной гипертензией приведет к уменьшению среднего артериального давления по сравнению с пациентами, получающими стандартное лечение.

Нулевая гипотеза: Средние значения артериального давления после лечения равны в обоих группах

Альтернативная гипотеза: Среднее значение давления в группе пациентов с новым лечением меньше чем в группе пациентов со стандартным лечением

Уровень значимости: 0.05 для одностороннего теста

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки (в каждой группе)
sample_size <- 80


# В популяции c экспериментальным методом лечения средний уровень систолического артериального давления меньше (130 vs 135 mm) 
# Генерация данных для группы с новым методом лечения 
group1 <- rnorm(sample_size, mean = 130, sd = 6)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rnorm(sample_size, mean = 135, sd = 10)  # контрольная группа

```

## Решение

Используем т-тест для независимых наблюдений с односторонней гипотезой, поскольку гипотеза предполагает именно уменьшение давления.

```{r}
t_test_result <- t.test(group1, group2, alternative = "less")
t_test_result

```

Посчитаем еще критическое значение для данной нулевой гипотезы, для этого используем формулу с лекции, только используем выборочную дисперсию как это делает т-тест в R, и посчитаем 0.95 квантиль т-распределения Стьюдента.

```{r}
s1_squared <- var(group1)  # Дисперсия первой группы
s2_squared <- var(group2)  # Дисперсия второй группы

A <- (s1_squared / sample_size) + (s2_squared / sample_size)
B <- ((s1_squared / sample_size)^2 / (sample_size - 1)) + 
     ((s2_squared / sample_size)^2 / (sample_size - 1))

df <- A^2 / B

t_critical <- -qt(1 - alpha, df)
t_critical
```

Полученный результат статистики (-3.05) по модулю больше чем критическое значение, поэтому отвергается нулевая гипотеза, что подтверждает посчитанное значение p-value.

Практическая значимость: статистически клиническая гипотеза об уменьшении давления является значимой и ее эффект с точки зрения клиники значимый, поскольку в среднем в группе с новым лекарством давление почти достигает нормального, по крайней мере для половины пациентов ( с учетом допущения что у нас не какая-то специфичная популяция, в общем популяции норма 120-129, так же делаем допущение, что распределение симметричное и среднее равно медиане) по сравнению с группой стандартного лечения, в которой в среднем давление выше нормального.

> ### Коммент Гипотеза 2. Что касается выбора теста, односторонняя гипотеза правильный выбор, но "Для простоты будем считать, что известно, что дисперсии равны" предполагает дополнительное допущение, что не очень правильно. Нет пункта с оценкой практической значимости.
>
> Ответ: изменила в исходном коде на т-тест с поправкой Уелча и добавила практическую значимость.

# Гипотеза 3. Внедрение программы реабилитации для пациентов с хронической болью в спине приведет к улучшению их физической активности (предположим что физическую активность можно оценить по шкале 0-100)

Нулевая гипотеза: Нет различий в уровне физической активности до и после реабилитации

Альтернативная гипотеза: Уровень физической активности после реабилитации выше

Уровень значимости: 0.05 для одностороннего теста

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки 
sample_size <- 30

# В популяции до реабилитации средний уровень физической активности меньше (50 vs 60) 
# Генерация данных до реабилитации
before <- rbinom(sample_size, size = 100, prob = 0.5)

# Генерация данных после реабилитации
after <- rbinom(sample_size, size = 100, prob = 0.6)

data <- data.frame(
  Before = before,
  After = after
)
```

## Решение

Критерий Уилкоксона для парных значений, поскольку выборка небольшая непараметрический тест подойдет лучше

```{r}

wilcox_test <- wilcox.test(data$Before, data$After, paired = TRUE, alternative = "less", exact = FALSE)
wilcox_test
```

Критическое значение для парного теста посчитать не очень просто, поскольку в случае когда размер выборки \>= 30 для подсчета p-value используется аппроксимация нормальным распределением <https://www.itl.nist.gov/div898/software/dataplot/refman1/auxillar/signrank.htm>\
Используя формулы среднего и стандартного отклонения можно посчитать сначала критическое значение для нормального распределения и потом перевести его в V исходя из формулы:

z = (V - mu(V))/sigma(V)

```{r}

mu <- sample_size*(sample_size + 1)/4
sigma <- sqrt(sample_size*(sample_size + 1)*(2*sample_size + 1)/24)

Z_critical <- qnorm(alpha/2)
V_critical <- mu + Z_critical*sigma
V_critical

```

Чтобы отвергнуть нулевую гипотезу в данном случае нужно чтобы V было меньше критического значения (137), что и получилось, поэтому p-value \< 0.05.

Практическая значимость: чтобы оценить клиническое значение нужно знать клинически-значимое изменение или нормальное значение физической активности для этой конкретной шкалы.
Так же отсутвие группы сравнения не дает корректно интерпретировать полученный результат, ведь мы не знаем не восстанавливается ли физическая активность со временем сама у этих пациентов.

> ### Коммент Гипотеза 3. Cгерированные данные не соответствуют условию (небходимо использовать функцию rbinom, так вы получите целые числа, а не float). Выбор теста правильный, но утверждение "но более существенно, что данные измерены в шкале" не очень корректно. Нет пункта с оценкой практической значимости.
>
> Ответ: переделала генерацию, поправила обоснование для теста и добавила практическую значимость

# Гипотеза 4. Применение нового метода лечения для пациентов с инфарктом миокарда увеличит долю вернувшихся к нормальной физической активности

Нулевая гипотеза: Доли пациентов вернувшихся к нормальной физической активности в группах со стандартным лечением и новым равны, то есть разница пропорций равна 0

Альтернативная гипотеза: Доля пациентов в группе с новым лечением больше чем в группе со стандартным, то есть разница пропорций больше 0

Уровень значимости: 0.05 для одностороннего доверительного интервала

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 200


# В популяции экспериментального лечения вероятность нормальной физической активности больше (0.7 vs 0.65)
# Генерация данных по статусу лечение (бинарная переменная, новый метод или стандарт) в фиксированном соотношении 1:1
treatment <- rep(c(1, 0), each = sample_size/2)

# Генерация данных по физической активности после лечения (бинарная переменная)
activity <- ifelse(treatment == 1, 
                   rbinom(sample_size/2, size = 1, prob = 0.7), 
                   rbinom(sample_size/2, size = 1, prob = 0.65))

data <- data.frame(Treatment = treatment, Activity = activity)

data_table <- table(data$Treatment, data$Activity)
data_table
```

## Решение

Используем односторонний доверительный интервал для разницы пропорций, по формуле отсюда <https://online.stat.psu.edu/stat100/lesson/9/9.3>

```{r}
# Подсчет успешных случаев в каждой группе
success_new <- sum(data$Activity[data$Treatment == 1])
success_standard <- sum(data$Activity[data$Treatment == 0])

n_new <- sum(data$Treatment == 1)
n_standard <- sum(data$Treatment == 0)

# доля успешных случаев в каждой группе
p_new <- success_new/n_new
p_standard <- success_standard/n_standard

#разница пропорций
diff_proportion <- (success_new/n_new) - (success_standard/n_standard)

#интервал
z_critical <- qnorm(0.95)
se_diff <- sqrt((p_new*(1 - p_new)/n_new) + (p_standard*(1 - p_standard)/n_standard))

lower_bound <- diff_proportion - z_critical*se_diff

cat('Доля вернувшихся к нормальной активности в группе с новым лечением',p_new, '\n')
cat('Доля вернувшихся к нормальной активности в группе со стандартным лечением:', p_standard, '\n')
cat('Разница долей между группами (новый метод - стандартное лечение):', diff_proportion, '\n')
cat('Нижняя граница 95% одностороннего доверительного интервала для разницы пропорций:', lower_bound, '\n')

```

Нижняя граница доверительного интервала для разницы пропорций меньше 0, что не дает основания отвергнуть нулевую гипотезу о равенстве пропорций.

```{r}
prop.test(data_table, alternative = "greater")
```

Тест на разницу пропорций подтвердил результат, полученный на доверительных интервалах: на даннной выборке не можем отвергнуть нулевую гипотезу.

Практическая значимость: статистически результаты теста не значимы, что не позволяет утверждать об положительном эффекте препарата, даже не смотря на одностороннюю гипотезу.
Эффект возможно и есть, но он настолько незначителен, что даже большой размер выборки не позволяет его детектировать.

> ### Коммент Гипотеза 4. Cгенерированные данные не соответствуют условию (отношение групп 1:1 и соотношение случаев внутри). Стратегия хорошая, но на всякий случай прогоните данные через prop.test (доверительные интервалы).Нет пункта с оценкой практической значимости.
>
> Ответ: поправила генерацию, результаты изменились на незначимые, поэтому исправила выводы и добавила prop.test и практическую значимость.

# Гипотеза 5. Применение медитации в течение 8 недель повлияет на наличие стресса (есть/нет) у лиц с высоким уровнем тревожности.

Нулевая гипотеза: применение медитации не связано с уровнем стресса у одних и тех же людей

Альтернативная гипотеза: применение медитации связано с уровнем стресса у одних и тех же людей

Уровень значимости: 0.05

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 50

# Генерация данных до медитации (бинарная переменная) в фиксированном соотношении 1:1
before <- sample(rep(c(1, 0), c(0.4*sample_size, 0.6*sample_size)))

# Генерация данных после медитации (бинарная переменная). После медитации вероятность наличия стресса меньше (0.2 vs 0.4)
after <- sample(rep(c(1, 0), c(0.2*sample_size, 0.8*sample_size)))

data <- data.frame(Before = before, After = after)
contingency_table <- table(data)

contingency_table


success_before <- sum(data$Before)
success_after  <- sum(data$After)

print(success_before/50)
print(success_after/50)
```

## Решение

Используем точный аналог теста Мак-Немара, этот тест является аналогом точно теста Фишера для связанных выборок, так как мы рассматриваем одних и тех же пациентов до воздействия и после.
Просто тест Мак-Немара не подходит, так как сумма ячеек b+c (14 + 4) \< 25 .

```{r}

mcnemar.exact(contingency_table)

```

```{r}
mcnemar.test(contingency_table)
```

P-value \< 0.05, что позволяет отвергнуть нулевую гипотезу о независимости медитации и уровня стресса.
Дополнительно в тесте посчитано OR с интервалом, OR статистически значимо отличается от 1, так как интервал не пересекает 1.

Практическая значимость: Как p-value так и odds ratio показывают значимый результат, оценка odds ratio далека от 1.
В абсолютных значениях результаты тоже выглядят убедительно: из 20 человек со стрессом до воздействия 14, то есть 70% не испытывают стресс после воздействия.
Для более надежной оценки еффекта было бы хорошо провести експеримент с группой сравнения, чтобы понять сколько людей перестают испытывать стресс без воздействия в течение 8 недель или по сравнению с другим страндартным воздействием.

> ### Коммент Гипотеза 5. Cгенерированные данные не соответствуют условию (0.1 vs 0.56 вместо 0.2 vs 0.4). Нет пункта с оценкой практической значимости. Что касается утверждения 'Просто тест Мак-Немара не подходит, так как в ячейках есть значения меньше 5.' - необходимо уточнить если это ожидаемые частоты или наблюдаемые.
>
> Ответ: поменяла генерацию, добавила практическую значимость, про выбор теста в случае небольших выборок в википедии например (<https://en.wikipedia.org/wiki/McNemar%27s_test>) пишут, что нужно ориентироваться на значения суммы диагонали b и с, меньше ли оно 25.
> В нашем случае эта сумма меньше 25, поэтому применение точного теста оправдано.
> Я так же добавила результаты ассимптотического теста, по уровню значимости в нашем случае между ними нет отличий.

# Гипотеза 6. Применение альтернативного метода лечения для пациентов с биполярным расстройством приведет к значимому изменению уровня симптомов депрессии по отношению к группе, прошедшей стандартное лечение (депрессию можно определить по шкале от 0 до 100, при этом исследователь должен избегать любых предположений (кроме i.i.d.)).

Нулевая гипотеза: Распределения уровня депресии в двух группах одинаковы

Альтернативная гипотеза: Распределения уровня депресии в двух группах смещены относительно друг друга

Уровень значимости: 0.05 для двустороннего теста

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки для каждой группы
sample_size <- 20


# В популяции c экспериментальным методом лечения среднее депрессии меньше (55 vs 68) 
# Генерация данных для экспериментальной группы 
group1 <- rbinom(sample_size, size = 100, prob = 0.55)

# Генерация данных после реабилитации
group2 <- rbinom(sample_size, size = 100, prob = 0.68)  # контрольная группа

```

## Решение

Критерий Уилкоксона - непараметрический аналог т-теста

```{r}

wilcox_test <- wilcox.test(group1, group2)
wilcox_test

```

Результат получился статистически значимым, в процессе появилась ошибка, которая говорит о наличии совпадающих значений внутри групп, поэтому автоматически применилась поправка p-value учитывающая это.

Практическая значимость: гипотеза оказалась статистически значимой не смотря на маленький размер выборки, непараметрический и двусторонний тест.
Вероятно причина в большом размере эффекта: по сравнению с уровнем в группе стандартного лечения оценка по шкале меньше почти на 20%.

> ### Коммент Гипотеза 6. Cгерированные данные не соответствуют условию (вы получили float числа, а не целые для шкалы). Выбор теста правильный. Нет пункта с оценкой практической значимости.
>
> Ответ: генерацию поправила и добавила практическую значимость.

# Гипотеза 7. Длительность сна (в часах) ассоциирована с уровенем стресса у студентов (шкала с нормальным распределением)

Нулевая гипотеза: Длительность сна и уровень стресса не связаны линейно

Альтернативная гипотеза: Длительность сна и уровень стресса связаны линейно

Уровень значимости: 0.05 для двустороннего теста

## Генерация данных

```{r}

library(mvtnorm) # библиотека mvtnorm для работы с многомерным нормальным распределением

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 100

# Средние значения для длительности сна (HoursOfSleep) и уровня стресса (StressLevel) в популяции
means <- c(7, 5)  

# Матрица ковариации. В ислледуемой популяции HoursOfSleep и StressLevel ассоциированы отрицательно (r = -0.5)
cov_matrix <-cov_matrix <- matrix(c(1, -0.5, 
                      -0.5, 1), nrow = 2)

df <- rmvnorm(n = sample_size, mean = means, sigma = cov_matrix) %>% 
      as_tibble() %>%
      setNames(c("HoursOfSleep", "StressLevel"))

head(df)
```

## Решение (дополните решение визуализацией)

Корреляция Пирсона, тк данные распределены нормально и выборка достаточно большая.

```{r}
cor_test <- cor.test(df$HoursOfSleep, df$StressLevel, method = "pearson")
cor_test

```

Результаты показывают, что корреляция статистически значимая при уровне значимости 0.05.
Это же подтверждает доверительный интервал для коэффициента корреляции, который не пересекается с 0.

```{r}
ggplot(df, aes(x = HoursOfSleep, y = StressLevel)) +
  geom_point() +
  geom_smooth(method = "lm", col = "blue", se = TRUE) +
  theme_minimal()
```

Практическая значимость: при размере выборки 100 видна явная отрицательная ассоциация между количеством сна и уровнем стресса студентов.
Хотя коэффициент корреляции не -1, но p-value значимый и очевидно, что в данной зависимости могут присутсвовать различные конфаундеры, медиаторы и прочие факторы, которые могут по-разному влиять на изучаемые величины.
По результатам корреляции нельзя сказать есть ли причинно-следственная связь, для этого требуется провести дополнительные эксперименты, например пострессовать студентов скорыми экзаменами и посмотреть на продолжительсть их сна, или лишить их сна и измерить уровень стресса.

> ### Коммент Гипотеза 7. Нет пункта с оценкой практической значимости.
>
> Ответ: добавила практическую значимость.
