---
title: "Классические_статистические_тесты ДЗ Гаранина"
author: "Irina Garanina"
date: "2024-11-17"
output: html_document
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(exact2x2)
library(ggplot2)
```

# Инструкции

Ниже приведены семь клинических (исследовательских) гипотез.
В качестве задания протестируйте их, используя соответствующие статистические критерии.
Решение должно содержать все элементы алгоритма проверки статистических гипотез:

• Сформулируете нулевую и альтернативную гипотезы.
• Укажите уровень значимости α.
• Определите статистический тест (критерий) для проверки гипотезы.
При необходимости аргументируйте выбор одностороннего теста.
• Укажите критическое значение статистики (используйте распределения из материалов лекции).
• Определите наблюдаемое значение статистики.
• Оцените статистическую значимость (p-value и/или доверительный интервал).
• Оцените практическую значимость.

-   Решение необходимо загружать в формате Rmd (воспроизводимый код). \*\* Данные для анализа необходимо генерировать самостоятельно в соответствии с каждой представленной гипотезой. По возможности используйте пакет dplyr \*\*\* Предусмотрен мягкий дедлайн (17 ноября). В этом случае вы получите комментарии с возможностью повысить оценку. Сдача работы после жёсткого дедлайна (24 ноября) предусматривает снижение оценки (10 баллов).

# Гипотеза 1. Существует ассоциация между уровнем физической активности (бинарная переменная, физическая активность может быть 'высокой' и 'низкой') и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет. Попробуйте вариант с большими выборками (sample_size \<- 100). Как изменится стратегия при малых выборках (sample_size \<- 30) ?

Нулевая гипотеза: Частота сердечно-сосудистых заболеваний не зависит от уровня физической активности, то есть не отличается у людей с высокой и низкой активностью

Альтернативная гипотеза: Частота сердечно-сосудистых заболеваний зависит от уровня физической активности, то есть она отличается у людей с высокой и низкой активностью.
Гипотеза двустороняя и не показывает в какой именно группе частота выше.

Уровень значимости: 0.05, тест по умолчанию односторонний

## Генерация данных, большая выборка

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки 
sample_size <- 100

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- sample(c("Высокая", "Низкая"), size = sample_size, replace = TRUE, prob = c(0.5, 0.5))

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio <- ifelse(activity == "Высокая", 
                 rbinom(sample_size, 1, 0.5), 
                 rbinom(sample_size, 1, 0.6))

data_large <- data.frame(Activity = activity, Cardio = cardio)
```

## Решение, большая выборка

Хи-квадрат тест, так как он быстрее вычисляется чем тест Фишера и на больших выборках работает не хуже

```{r}
alpha = 0.05
contingency_table_large <- table(data_large$Activity, data_large$Cardio)

contingency_table_large
```

```{r}
chi2_test <- chisq.test(contingency_table_large)
chi2_test
```

Чтобы посчитать критическое значение статистики Хи-квадрат теста посчитаем 1-alpha квантиль распределения хи-квадрат с одной степенью свободы, распределение хи-звадрат всегда положительное, поэтому критическое значение считается только с одной стороны

```{r}
qchisq(1 - alpha, 1)
```

Критическое значение больше посчитанного тестом значения статистики (3.08), что не дает основания отвергнуть нулевую гипотезу

## Генерация данных, маленькая выборка

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 30

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- sample(c("Высокая", "Низкая"), size = sample_size, replace = TRUE, prob = c(0.5, 0.5))

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio <- ifelse(activity == "Высокая", 
                 rbinom(sample_size, 1, 0.5), 
                 rbinom(sample_size, 1, 0.6))

data_small <- data.frame(Activity = activity, Cardio = cardio) 
```

## Решение, маленькая выборка

На маленькой выборке тест Фишера предпочтительнее (менее 5 наблюдений на клетку таблицы), так как ассимптотические предположения хи-квадрат теста могут не выполняться

```{r}
contingency_table_small <- table(data_small$Activity, data_small$Cardio)

contingency_table_small
```

```{r}
fisher_test <- fisher.test(contingency_table_small)
fisher_test
```

Точный тест Фишера не является ассимптотическим, он основан на вычислении вероятности получить наблюдаемое распределение частот при фиксированных суммах по строкам и столбцам, что и выводится как p-value.
Так же встроенная функция в R считает odds ratio и его доверительный интервал, что напрямую не связано с тестом Фишера.
В данном случае доверительный интервал так же подтверждает результаты, так как включает 1.

# Гипотеза 2. Применение нового метода лечения для пациентов с артериальной гипертензией приведет к уменьшению среднего артериального давления по сравнению с пациентами, получающими стандартное лечение.

Нулевая гипотеза: Средние значения артериального давления после лечения равны в обоих группах

Альтернативная гипотеза: Среднее значение давления в группе пациентов с новым лечением меньше чем в группе пациентов со стандартным лечением

Уровень значимости: 0.05 для одностороннего теста

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки (в каждой группе)
sample_size <- 80


# В популяции c экспериментальным методом лечения средний уровень систолического артериального давления меньше (130 vs 135 mm) 
# Генерация данных для группы с новым методом лечения 
group1 <- rnorm(sample_size, mean = 130, sd = 10)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rnorm(sample_size, mean = 135, sd = 10)  # контрольная группа

```

## Решение

Используем т-тест для независимых наблюдений с односторонней гипотезой, поскольку гипотеза предполагает именно уменьшение давления.
Для простоты будем считать, что известно, что дисперсии равны, хотя в реальном случае случае лучше использовать функцию по умолчанию, которая считает стпени свободы используя метод Уелча.

```{r}
t_test_result <- t.test(group1, group2, alternative = "less", var.equal = TRUE)
t_test_result
```

Посчитаем еще критическое значение для данной нулевой гипотезы, для этого используем обычный df и посчитаем 0.95 квантиль т-распределения Стьюдентаю.
Рассчитаем критическое значение без поправки Уелча.

```{r}
df = 80 + 80 - 2
t_critical <- -qt(1 - alpha, df)
t_critical
```

Полученный результат статистики (-2.37) по модулю больше чем критическое значение, поэтому отвергается нулевая гипотеза, что подтверждает посчитанное значение p-value.

# Гипотеза 3. Внедрение программы реабилитации для пациентов с хронической болью в спине приведет к улучшению их физической активности (предположим что физическую активность можно оценить по шкале 0-100)

Нулевая гипотеза: Нет различий в уровне физической активности до и после реабилитации

Альтернативная гипотеза: Уровень физической активности после реабилитации выше

Уровень значимости: 0.05 для одностороннего теста

## Генерация данных

В задании был записан rbinom изначально для моделирования, но я думаю, что тут подходит нормальное распредление лучше, так как рассматривается среднее значение, а не бинарный исход.

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки 
sample_size <- 30

# В популяции до реабилитации средний уровень физической активности меньше (50 vs 60) 
# Генерация данных до реабилитации
before <- rnorm(sample_size, mean = 50, sd = 10)

# Генерация данных после реабилитации
after <- rnorm(sample_size, mean = 60, sd = 10)  

data <- data.frame(
  Before = before,
  After = after
)
```

## Решение

Критерий Уилкоксона для парных значений, поскольку выборка небольшая, но более существенно, что данные измерены в шкале и поэтому непараметриский тест, основанный на ранжировании подойдет лучше

```{r}

wilcox_test <- wilcox.test(data$Before, data$After, paired = TRUE, alternative = "less", exact = FALSE)
wilcox_test
```

Критическое значение для парного теста посчитать не очень просто, поскольку в случае когда размер выборки \>= 30 для подсчета p-value используется аппроксимация нормальным распределением <https://www.itl.nist.gov/div898/software/dataplot/refman1/auxillar/signrank.htm>\
Используя формулы среднего и стандартного отклонения можно посчитать сначала критическое значение для нормального распределения и потом перевести его в V исходя из формулы:

z = (V - mu(V))/sigma(V)

```{r}

mu <- sample_size*(sample_size + 1)/4
sigma <- sqrt(sample_size*(sample_size + 1)*(2*sample_size + 1)/24)

Z_critical <- qnorm(alpha/2)
V_critical <- mu + Z_critical*sigma
V_critical
```

Чтобы отвергнуть нулевую гипотезу в данном случае нужно чтобы V было меньше критического значения (137), что и получилось, поэтому p-value \< 0.05.

# Гипотеза 4. Применение нового метода лечения для пациентов с инфарктом миокарда увеличит долю вернувшихся к нормальной физической активности

Нулевая гипотеза: Доли пациентов вернувшихся к нормальной физической активности в группах со стандартным лечением и новым равны, то есть разница пропорций равна 0

Альтернативная гипотеза: Доля пациентов в группе с новым лечением больше чем в группе со стандартным, то есть разница пропорций больше 0

Уровень значимости: 0.05 для одностороннего доверительного интервала

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 200


# В популяции экспериментального лечения вероятность нормальной физической активности больше (0.7 vs 0.65)
# Генерация данных по статусу лечение (бинарная переменная, новый метод или стандарт) в фиксированном соотношении 1:1
treatment <- sample(c(1, 0), size = sample_size, replace = TRUE, prob = c(0.5, 0.5))

# Генерация данных по физической активности после лечения (бинарная переменная)
activity <- ifelse(treatment == 1, 
                   rbinom(sample_size, size = 1, prob = 0.7), 
                   rbinom(sample_size, size = 1, prob = 0.65))

data <- data.frame(Treatment = treatment, Activity = activity)
```

## Решение

Используем односторонний доверительный интервал для разницы пропорций, по формуле отсюда <https://online.stat.psu.edu/stat100/lesson/9/9.3>

```{r}
# Подсчет успешных случаев в каждой группе
success_new <- sum(data$Activity[data$Treatment == 1])
success_standard <- sum(data$Activity[data$Treatment == 0])

n_new <- sum(data$Treatment == 1)
n_standard <- sum(data$Treatment == 0)

# доля успешных случаев в каждой группе
p_new <- success_new/n_new
p_standard <- success_standard/n_standard

#разница пропорций
diff_proportion <- (success_new/n_new) - (success_standard/n_standard)

#интервал
z_critical <- qnorm(0.95)
se_diff <- sqrt((p_new*(1 - p_new)/n_new) + (p_standard*(1 - p_standard)/n_standard))

lower_bound <- diff_proportion - z_critical*se_diff

cat('Доля вернувшихся к нормальной активности в группе с новым лечением',p_new, '\n')
cat('Доля вернувшихся к нормальной активности в группе со стандартным лечением:', p_standard, '\n')
cat('Разница долей между группами (новый метод - стандартное лечение):', diff_proportion, '\n')
cat('Нижняя граница 95% одностороннего доверительного интервала для разницы пропорций:', lower_bound, '\n')
```

Нижняя граница доверительного интервала для разницы пропорций больше 0, что говорит о значимости отличия пропорции от 0.

# Гипотеза 5. Применение медитации в течение 8 недель повлияет на наличие стресса (есть/нет) у лиц с высоким уровнем тревожности.

Нулевая гипотеза: применение медитации не связано с уровнем стресса у одних и тех же людей

Альтернативная гипотеза: применение медитации связано с уровнем стресса у одних и тех же людей

Уровень значимости: 0.05

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 50

# Генерация данных до медитации (бинарная переменная) в фиксированном соотношении 1:1
before <- rbinom(sample_size, size = 1, prob = 0.4)

# Генерация данных после медитации (бинарная переменная). После медитации вероятность наличия стресса меньше (0.2 vs 0.4)
after <- rbinom(sample_size, size = 1, prob = 0.2)

data <- data.frame(Before = before, After = after)
contingency_table <- table(data)

contingency_table
```

## Решение

Используем точный аналог теста Мак-Немара, этот тест является аналогом точно теста Фишера для связанных выборок, так как мы рассматриваем одних и тех же пациентов до воздействия и после.
Просто тест Мак-Немара не подходит, так как в ячейках есть значения меньше 5.

```{r}

mcnemar.exact(contingency_table)
```

P-value \< 0.05, что позволяет отвергнуть нулевую гипотезу о независимости медитации и уровня стресса.
Дополнительно в тесте посчитано OR с интервалом, OR статистически значимо отличается от 1, так как интервал не пересекает 1.

# Гипотеза 6. Применение альтернативного метода лечения для пациентов с биполярным расстройством приведет к значимому изменению уровня симптомов депрессии по отношению к группе, прошедшей стандартное лечение (депрессию можно определить по шкале от 0 до 100, при этом исследователь должен избегать любых предположений (кроме i.i.d.)).

Нулевая гипотеза: Распределения уровня депресии в двух группах одинаковы

Альтернативная гипотеза: Распределения уровня депресии в двух группах смещены относительно друг друга

Уровень значимости: 0.05 для двустороннего теста

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки для каждой группы
sample_size <- 20


# В популяции c экспериментальным методом лечения среднее депрессии меньше (55 vs 68) 
# Генерация данных для экспериментальной группы 
group1 <- rnorm(sample_size, mean = 55, sd = 3)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rnorm(sample_size, mean = 68, sd = 3)  # контрольная группа

```

## Решение

Критерий Уилкоксона - непараметрический аналог т-теста, p-value будет рассчитан как точный из-за небольшого размера выборки

```{r}

wilcox_test <- wilcox.test(group1, group2, exact = TRUE)
wilcox_test
```

Результат получился статистически незначимым, вероятно из-за небольшого размера выборки и непараметрического теста, у которого мощность ниже чем у параметрических.

# Гипотеза 7. Длительность сна (в часах) ассоциирована с уровенем стресса у студентов (шкала с нормальным распределением)

Нулевая гипотеза: Длительность сна и уровень стресса не связаны линейно

Альтернативная гипотеза: Длительность сна и уровень стресса связаны линейно

Уровень значимости: 0.05 для двустороннего теста

## Генерация данных

```{r}

library(mvtnorm) # библиотека mvtnorm для работы с многомерным нормальным распределением

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 100

# Средние значения для длительности сна (HoursOfSleep) и уровня стресса (StressLevel) в популяции
means <- c(7, 5)  

# Матрица ковариации. В ислледуемой популяции HoursOfSleep и StressLevel ассоциированы отрицательно (r = -0.5)
cov_matrix <-cov_matrix <- matrix(c(1, -0.5, 
                      -0.5, 1), nrow = 2)

df <- rmvnorm(n = sample_size, mean = means, sigma = cov_matrix) %>% 
      as_tibble() %>%
      setNames(c("HoursOfSleep", "StressLevel"))

head(df)
```

## Решение (дополните решение визуализацией)

Корреляция Пирсона, тк данные распределены нормально и выборка достаточно большая.

```{r}
cor_test <- cor.test(df$HoursOfSleep, df$StressLevel, method = "pearson")
cor_test

```

Результаты показывают, что корреляция статистически значимая при уровне значимости 0.05.
Это же подтверждает доверительный интервал для коэффициента корреляции, который не пересекается с 0.

```{r}
ggplot(df, aes(x = HoursOfSleep, y = StressLevel)) +
  geom_point() +
  geom_smooth(method = "lm", col = "blue", se = TRUE) +
  theme_minimal()
```
